<!DOCTYPE HTML>
<html lang="en">
<head>
    <title>Globe of War</title>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
	<meta name="author" content="wargaming.net">
    
	<link rel="shortcut icon" href="favicon.ico">
    <link rel="stylesheet" type="text/css" href="css/menuwidget.css">
    <link rel="stylesheet" type="text/css" href="css/twitterwidget.css">
    <link rel="stylesheet" type="text/css" href="css/globewidget.css">
    
    <style type="text/css">
        html {
            height: 100%;
        }

        body {
            margin: 0;
            padding: 0;
            background: #000000 url(image/loading.gif) center center no-repeat;
            color: #ffffff;
            font-family: sans-serif;
            font-size: 13px;
            line-height: 20px;
            height: 100%;
        }
    </style>

	<script type="text/javascript" src="third-party/detector.js"></script>
	<script type="text/javascript" src="third-party/three.js"></script>
	<script type="text/javascript" src="third-party/jquery-2.1.4.min.js"></script>
	<script type="text/javascript" src="third-party/dat.gui.js"></script>
	<script type="text/javascript" src="third-party/tween.js"></script>
	<script type="text/javascript" src="third-party/jquery.vticker-min.js"></script>
	<script type="text/javascript" src="css/globeoptions.js"></script>
	<script type="text/javascript" src="widget/globewidget.js"></script>
</head>

<body>
	<div id="globe-container"></div>

	<div class="menu-container">
		<div id="regions">
			<ul class="panel">
				<li><h3>REGIONS:</h3></li>
				<li id="regionAll"           class="animation">All Regions</a></li>
				<li id="regionEurope"        class="animation">Europe</li>
				<li id="regionKorea"         class="animation">Korea</li>
				<li id="regionNorthAmerica"  class="animation">North America</li>
				<li id="regionNorthChina"    class="animation">North China</li>
				<li id="regionRussia"        class="animation">Russia</li>
				<li id="regionSouthChina"    class="animation">South China</li>
				<li id="regionSouthEastAsia" class="animation">South-East Asia</li>
			</ul>
		</div>
		<div id="statistics">
			<ul class="panel">
				<li><h3>DISPLAY:</h3></li>
				<li id="statBattles"          class="animation">Battles/Players</a></li>
				<li id="statTwitts"           class="animation">Latest Twitts</li>
			</ul>
		</div>
	</div>

	<div id="twitter-container">
		<ul id="twitter-items">
		</ul>
	</div>

	<script type="text/javascript">

	
		$('#twitter-container').hide();

		if (!Detector.webgl) {
			Detector.addGetWebGLMessage();
		} else {

			var container = document.getElementById('globe-container');
			var globe = new DAT.Globe(container, globeOptions);

			var ajaxRegions = null;
			var ajaxTweet = null;

			var curView = "PCU"; // PCU, Tweets, Region
			var regionName = null;
			
			function processTweets(jsonObj) {
				if(jsonObj == undefined || jsonObj._items == undefined) {
					return;
				}

				$( "#twitter-items" ).empty();
		
				var tweets = jsonObj._items;

				tweets.forEach(function(tweet){
					msg = tweet.text;
					$( "#twitter-items" ).append("<li><blockquote class=\"twitter-tweet\">" + msg + "</blockquote></li>");
				});

				$('#twitter-container').show();
		
				$('#twitter-container').vTicker({ 
					speed: 500,
					pause: 3000,
					showItems: 6,
					animation: 'fade',
					mousePause: true,
					height: 0,
					direction: 'up'
				});
	
				$('#twitter-container').hide();
			};

			function requestTweets() {
				$.ajax({
					url: 'tweets.json',
					//dataType: 'json',
					type: 'GET',
					async: true,
					cache: false,
					error: function () {
						return true;
					},
					success: function (msg) {
						ajaxTweet = msg;
						globe.removeOldTweets();
						if(curView == "Tweets"){
							globe.drawTweets(ajaxTweet);
						}
						processTweets(ajaxTweet);
					}
				});
			}

			function requestRegions() {
				$.ajax({
					url: 'regions.json',
					//dataType: 'json',
					type: 'GET',
					async: true,
					cache: false,
					error: function () {
						return true;
					},
					success: function (msg) {
						ajaxRegions = msg;
						globe.removeOldData();
						if(curView == "PCU") {
							globe.drawPCUStatistic(ajaxRegions);
						} else if(curView == "Region"){
							globe.drawGameStatistic(ajaxRegions, regionName);
						}
					}
				});
			}

			$(document).ready(function ($) {
				requestRegions();
				requestTweets();
				
				globe.animate();
				document.body.style.backgroundImage = 'none';

				$("#regions").click(function(event) {
					$( "*" ).removeClass( "active" );
					$(event.target).toggleClass('active');

					globe.removeOldData();
					globe.removeOldTweets();

					$("#twitter-container").fadeIn();
					$("#twitter-container").hide();

					switch ($(event.target).attr("id")) {
						case "regionAll" : 
							globe.drawPCUStatistic(ajaxRegions);
							globe.setCameraToRegion("All");
							curView = "PCU";
							break;
						default :
							var region = $(event.target).text();
							globe.drawGameStatistic(ajaxRegions, region);
							globe.setCameraToRegion(region);
							curView = "Region";
							regionName = event.target.innerText;
					}
				});

				$("#statistics").click(function(event) {
					$( "*" ).removeClass( "active" );
					$(event.target).toggleClass('active');

					globe.removeOldData();
					globe.removeOldTweets();
					
					$("#twitter-container").fadeIn();
					$("#twitter-container").hide();

					switch ($(event.target).attr("id")) {
						case "statBattles" : 
							globe.drawPCUStatistic(ajaxRegions);
							globe.setCameraToRegion("All");
							curView = "PCU";
							break;
						case "statTwitts" : 
							globe.drawTweets(ajaxTweet);
							$("#twitter-container").show();
							curView = "Tweets";
							break;
					}
				});
			});

			setInterval(requestRegions, 60000 * 60 * 24); // once per day
			setInterval(requestTweets, 60000 * 60); // once per hour
		}

	</script>
</body>
</html>
